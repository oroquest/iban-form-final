<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IBAN-Erfassung – SIKURA Leben AG i.L.</title>
  <style>
    :root{--fg:#0b0b0b;--bg:#fff;--muted:#666;--border:#e6e6e6}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--fg)}
    .container{max-width:860px;margin:32px auto;padding:0 16px}
    h1,h2{margin:8px 0 12px}
    .hint{color:var(--muted);margin:-2px 0 12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:flex;flex-direction:column;gap:6px;font-weight:600}
    input,select,button{padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-weight:500}
    input[disabled]{background:#fafafa;color:#777}
    hr{margin:28px 0;border:none;border-top:1px solid var(--border)}
    .checks{margin:12px 0;display:flex;flex-direction:column;gap:8px}
    .error{color:#b00020;font-size:14px;margin:6px 0 0;display:none}
    .small{color:var(--muted);font-size:14px}
    button{cursor:pointer}
    @media (max-width:680px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <main class="container">
    <!-- OBERER TEIL: Verify-Daten nur anzeigen (wie im Verify-Flow) -->
    <section>
      <h1>Bitte bestätigen Sie Ihre bereits erfassten Daten</h1>
      <p class="hint">Die folgenden Angaben stammen aus Ihrem bereits bestätigten Verify‑Prozess und sind nur zur Kontrolle sichtbar.</p>
      <div class="grid">
        <label>Gläubiger‑Nr.
          <input id="ro_creditor" disabled />
        </label>
        <label>Vorname
          <input id="ro_firstname" disabled />
        </label>
        <label>Nachname
          <input id="ro_lastname" disabled />
        </label>
        <label>Strasse
          <input id="ro_street" disabled />
        </label>
        <label>Nr.
          <input id="ro_houseno" disabled />
        </label>
        <label>PLZ
          <input id="ro_zip" disabled />
        </label>
        <label>Ort
          <input id="ro_city" disabled />
        </label>
        <label>Land
          <input id="ro_country" disabled />
        </label>
      </div>
    </section>

    <hr />

    <!-- UNTERER TEIL: IBAN-Erfassung -->
    <section>
      <h2>IBAN erfassen</h2>
      <form id="ibanForm" method="POST" action="/.netlify/functions/iban_submit" novalidate>
        <label>IBAN*
          <input id="iban" name="iban" required maxlength="34" placeholder="CH93 0076 2011 6238 5295 7" />
          <span id="ibanErr" class="error">Bitte eine gültige IBAN eingeben (Format & Prüfsumme).</span>
        </label>

        <label>BIC (optional)
          <input id="bic" name="bic" maxlength="11" placeholder="ZKBKCHZZ80A" />
          <span id="bicErr" class="error">BIC ist ungültig.</span>
        </label>

        <label>Kontoinhaber (optional)
          <input id="acc_holder" name="glaeubiger" autocomplete="name" />
        </label>

        <!-- Hidden Felder wie im Verify-Prozess -->
        <input type="hidden" id="hid_id" name="id" />
        <input type="hidden" id="hid_token" name="token" />
        <input type="hidden" id="hid_em" name="em" />
        <input type="hidden" id="hid_lang" name="lang" />

        <div class="checks">
          <label><input type="checkbox" id="cb1" required /> Ich bestätige, dass die Angaben korrekt sind.</label>
          <label><input type="checkbox" id="cb2" required /> Ich stimme der Verarbeitung gemäss Datenschutzhinweisen zu.</label>
        </div>

        <button type="submit">Senden</button>
        <p class="small"><a href="/privacy.html" target="_blank" rel="noopener">Datenschutzhinweise</a></p>
      </form>
    </section>
  </main>

  <script>
    // ---------- Hilfsfunktionen (IBAN Client-Check wie besprochen) ----------
    function ibanSanitize(s){ return String(s||'').toUpperCase().replace(/\s+/g,''); }
    function toNum(ch){ const c=ch.charCodeAt(0); if(c>=48&&c<=57) return ch; if(c>=65&&c<=90) return String(c-55); return ''; }
    function mod97Str(str){ let rem=0,buf=''; for(const ch of str){ buf+=toNum(ch); while(buf.length>=7){ rem = Number(String(rem)+buf.slice(0,7))%97; buf = buf.slice(7);} } if(buf.length) rem = Number(String(rem)+buf)%97; return rem; }
    function ibanIsValid(raw){
      const s = ibanSanitize(raw);
      if(!/^[A-Z]{2}\d{2}[A-Z0-9]{11,30}$/.test(s)) return false;
      const rearr = s.slice(4)+s.slice(0,4);
      return mod97Str(rearr) === 1;
    }
    function bicIsValid(raw){
      const s = String(raw||'').toUpperCase().trim();
      if(!s) return true; // optional
      return /^[A-Z]{6}[A-Z0-9]{2}([A-Z0-9]{3})?$/.test(s);
    }
    function formatIBAN(raw){ return ibanSanitize(raw).replace(/(.{4})/g,'$1 ').trim(); }

    // ---------- URL-Parameter & Hidden Felder (wie Verify) ----------
    const qs = new URLSearchParams(location.search);
    const q_id    = (qs.get('id')||'').trim();
    const q_token = (qs.get('token')||'').trim();
    const q_em    = (qs.get('em')||'').trim();
    const q_lang  = (qs.get('lang')||'de').toLowerCase();

    document.getElementById('hid_id').value    = q_id;
    document.getElementById('hid_token').value = q_token;
    document.getElementById('hid_em').value    = q_em;
    document.getElementById('hid_lang').value  = q_lang;

    // Zeige die Gläubiger-Nr. direkt aus der URL (wie gewünscht)
    document.getElementById('ro_creditor').value = q_id;

    // ---------- Verify-Check aufrufen und Anzeige füllen (wie im Verify-Prozess) ----------
    // Wir nutzen den bestehenden verify_check-Endpoint, der im kopierten Verify-Repo schon funktioniert.
    (async () => {
      try {
        const url = `/.netlify/functions/verify_check?id=${encodeURIComponent(q_id)}&token=${encodeURIComponent(q_token)}&lang=${encodeURIComponent(q_lang)}&em=${encodeURIComponent(q_em)}`;
        const r = await fetch(url);
        if(!r.ok) throw new Error('verify_check_failed');
        const data = await r.json();

        // Tolerantes Mapping, damit es 1:1 mit euren Verify-Props funktioniert.
        const p = data.display || data || {};

        const first = p.firstname || p.vorname || '';
        const last  = p.name || p.nachname || '';
        const street= p.strasse || p.adresse_strasse || p.street || '';
        const houseno = p.hausnummer || p.adresse_hausnummer || p.nr || '';
        const zip   = p.plz || p.adresse_plz || p.zip || '';
        const city  = p.ort || p.adresse_ort || p.city || '';
        const country = p.land || p.adresse_land || p.country || '';

        document.getElementById('ro_firstname').value = first;
        document.getElementById('ro_lastname').value  = last;
        document.getElementById('ro_street').value    = street;
        document.getElementById('ro_houseno').value   = houseno;
        document.getElementById('ro_zip').value       = zip;
        document.getElementById('ro_city').value      = city;
        document.getElementById('ro_country').value   = country;
      } catch(e){
        // Wenn der Check fehlschlägt (Token falsch/abgelaufen), freundlich abbrechen
        alert("Der Zugriffslink ist ungültig oder abgelaufen.");
      }
    })();

    // ---------- UX: Live-Format & Validierung ----------
    const $iban = document.getElementById('iban');
    const $bic  = document.getElementById('bic');
    const $ibanErr = document.getElementById('ibanErr');
    const $bicErr  = document.getElementById('bicErr');

    $iban.addEventListener('input', () => {
      const caret = $iban.selectionStart;
      const before = $iban.value;
      $iban.value = formatIBAN(before);
      // Caret-Repositionierung ist optional; hier simpel.
    });

    document.getElementById('ibanForm').addEventListener('submit', (ev) => {
      $ibanErr.style.display = 'none';
      $bicErr.style.display = 'none';

      const rawIban = $iban.value;
      const rawBic  = $bic.value;

      if(!ibanIsValid(rawIban)){
        ev.preventDefault();
        $ibanErr.style.display = 'block';
        return;
      }
      if(!bicIsValid(rawBic)){
        ev.preventDefault();
        $bicErr.style.display = 'block';
        return;
      }

      // Vor dem Submit sauber machen
      $iban.value = ibanSanitize(rawIban);
    });
  </script>
</body>
</html>
